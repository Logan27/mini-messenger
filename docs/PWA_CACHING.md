# PWA & Caching Strategy Implementation

## Overview

This document describes the Progressive Web App (PWA) and caching strategy implementation for Mini Messenger, including service workers, offline support, and message queuing.

## Features Implemented

### 1. Service Worker (Workbox)

The service worker is automatically generated by `vite-plugin-pwa` during the build process. It provides:

- **Precaching**: All static assets (JS, CSS, HTML) are cached on first load
- **Runtime Caching**: Dynamic content is cached based on defined strategies
- **Offline Fallback**: Custom offline page when network is unavailable
- **Automatic Updates**: New service workers automatically activate

#### Caching Strategies

| Resource Type | Strategy | Cache Duration | Cache Name |
|--------------|----------|----------------|------------|
| API Messages/Conversations | Network First | 5 minutes | api-cache |
| User Profiles/Avatars | Cache First | 24 hours | user-cache |
| Images (PNG, JPG, SVG, etc.) | Cache First | 30 days | image-cache |
| File Uploads/Downloads | Network Only | N/A | N/A |
| WebSocket Connections | Network Only | N/A | N/A |

**Network First**: Try network first, fallback to cache if offline (good for dynamic data)
**Cache First**: Try cache first, fallback to network if not cached (good for static data)
**Network Only**: Always fetch from network, never cache (good for real-time data)

### 2. PWA Manifest

Location: `public/manifest.webmanifest`

The manifest enables app installation with:

- App name, description, and branding
- Theme color (#2563eb) and background color (#ffffff)
- Standalone display mode (looks like a native app)
- Icon configurations for various sizes
- Shortcuts for quick actions
- iOS-specific metadata

### 3. Offline Page

Location: `public/offline.html`

A beautiful standalone page shown when users navigate while offline:

- Gradient background design
- Connection status indicator with animation
- "Try Again" button for manual retry
- Quick tips for troubleshooting
- Auto-reload when connection is restored (checks every 5 seconds)

### 4. Offline Message Queue

Location: `frontend/src/services/offlineQueue.service.ts`

An IndexedDB-based queue system that:

- Stores messages when sent while offline
- Automatically sends messages when connection is restored
- Supports retry logic (default: 3 attempts)
- Persists across browser sessions
- Provides queue count and status updates
- Shows toast notifications for queue operations

#### API

```typescript
import { offlineQueueService } from '@/services/offlineQueue.service';

// Add item to queue
await offlineQueueService.addToQueue({
  type: 'message',
  endpoint: '/messages',
  method: 'POST',
  data: messageData,
  maxRetries: 3,
});

// Get queue count
const count = await offlineQueueService.getQueueCount();

// Subscribe to queue changes
const unsubscribe = offlineQueueService.subscribe((count) => {
  console.log(`Queue has ${count} items`);
});

// Process queue manually
await offlineQueueService.processQueue();
```

### 5. PWA Components

#### PWAInstallPrompt

Location: `frontend/src/components/PWAInstallPrompt.tsx`

A banner that prompts users to install the app as a PWA:

- Appears when browser supports PWA installation
- Can be dismissed (persists for session)
- Automatically hides when app is already installed
- Positioned at bottom right on desktop, bottom center on mobile

#### PWAUpdatePrompt

Location: `frontend/src/components/PWAUpdatePrompt.tsx`

A notification that appears when a new version is available:

- Prompts user to reload to get latest updates
- Can be dismissed to update later
- Positioned at top right to not interfere with main UI

### 6. PWA Service

Location: `frontend/src/services/pwa.service.ts`

A singleton service that manages PWA functionality:

```typescript
import { pwaService } from '@/services/pwa.service';

// Check if app can be installed
const canInstall = pwaService.canInstall();

// Check if app is already installed
const isInstalled = pwaService.isInstalled();

// Show install prompt
const result = await pwaService.showInstallPrompt();
// Returns: 'accepted' | 'dismissed' | 'unavailable'

// Subscribe to install availability
const unsubscribe = pwaService.subscribeToInstallPrompt((canInstall) => {
  console.log(`Can install: ${canInstall}`);
});

// Get display mode
const mode = pwaService.getDisplayMode();
// Returns: 'browser' | 'standalone' | 'minimal-ui' | 'fullscreen'
```

## Configuration

### Vite Configuration

Location: `frontend/vite.config.ts`

The PWA plugin is configured with:

```typescript
VitePWA({
  registerType: 'prompt', // Prompt user before updating
  includeAssets: ['favicon.ico', 'favicon.svg', 'robots.txt', 'offline.html'],
  manifest: { /* ... */ },
  workbox: {
    maximumFileSizeToCacheInBytes: 5 * 1024 * 1024, // 5MB
    cleanupOutdatedCaches: true,
    skipWaiting: true,
    clientsClaim: true,
    navigateFallback: '/offline.html',
    runtimeCaching: [ /* ... */ ],
  },
})
```

### Environment Variables

The API base URL is configured via:

```bash
VITE_API_URL=http://localhost:4000/api
```

Update the `runtimeCaching` URL patterns in `vite.config.ts` if you change the API URL.

## Integration

### App.tsx

The PWA components are integrated at the root level:

```tsx
<ThemeProvider>
  <TooltipProvider>
    <OfflineBanner />        {/* Existing offline indicator */}
    <PWAUpdatePrompt />      {/* New: Update notification */}
    <PWAInstallPrompt />     {/* New: Install prompt */}
    <Toaster />
    <Sonner />
    <BrowserRouter>
      {/* Routes */}
    </BrowserRouter>
  </TooltipProvider>
</ThemeProvider>
```

### Message Service

Location: `frontend/src/services/message.service.ts`

The message service automatically uses the offline queue when offline:

```typescript
async sendMessage(data) {
  // Check if user is offline
  if (!navigator.onLine) {
    // Add to offline queue
    await offlineQueueService.addToQueue({
      type: 'message',
      endpoint: '/messages',
      method: 'POST',
      data,
      maxRetries: 3,
    });

    toast.info('Message queued. Will send when online.');

    // Return temporary message for optimistic UI
    return { /* ... */ };
  }

  // Normal online sending
  const response = await apiClient.post('/messages', data);
  return response.data.data;
}
```

## Testing

### Development

The service worker is disabled in development mode for easier debugging:

```typescript
devOptions: {
  enabled: false,
}
```

To test PWA features in development, build and preview:

```bash
npm run build
npm run preview
```

### Production Build

Build the app to generate the service worker:

```bash
npm run build
```

This will output:
- `dist/sw.js` - Service worker
- `dist/workbox-*.js` - Workbox runtime
- `dist/manifest.webmanifest` - PWA manifest

### Testing Offline Functionality

1. Build and serve the app:
   ```bash
   npm run build && npm run preview
   ```

2. Open DevTools → Application → Service Workers
3. Check "Offline" to simulate offline mode
4. Navigate around the app to see cached content
5. Try sending a message - it should be queued
6. Uncheck "Offline" to restore connection
7. Queued message should send automatically

### Testing PWA Installation

#### Chrome/Edge (Desktop)

1. Visit the app in production mode
2. Look for the install icon in the address bar (right side)
3. Or use the PWA install prompt banner
4. Click "Install" to add app to desktop

#### Chrome/Edge (Android)

1. Visit the app on mobile
2. Menu → "Add to Home Screen" or "Install App"
3. Follow the installation prompts

#### iOS Safari

1. Visit the app on iPhone/iPad
2. Tap the Share button
3. Select "Add to Home Screen"
4. The app will appear as an icon on the home screen

## Browser Support

### Service Workers

- ✅ Chrome 40+
- ✅ Firefox 44+
- ✅ Safari 11.1+
- ✅ Edge 17+
- ❌ Internet Explorer (not supported)

### PWA Installation

- ✅ Chrome (all platforms)
- ✅ Edge (all platforms)
- ✅ Samsung Internet
- ✅ Opera
- ⚠️ iOS Safari (Add to Home Screen only, not full PWA)
- ❌ Firefox (service worker works, but no install prompt)

### IndexedDB (Offline Queue)

- ✅ All modern browsers
- ✅ Chrome 24+
- ✅ Firefox 16+
- ✅ Safari 10+
- ✅ Edge 12+

## Performance Metrics

### Initial Load (First Visit)

- Downloads all static assets (~1.1 MB total)
- Service worker registers in background
- Precaches assets for offline use

### Subsequent Loads

- **HTML**: Cache first (instant)
- **CSS**: Cache first (instant)
- **JS**: Cache first (instant)
- **API Data**: Network first with 5-minute cache
- **Images**: Cache first with 30-day cache

### Cache Storage Usage

- Static assets: ~1.1 MB
- API cache: ~100 entries, max 5 minutes each
- User cache: ~50 entries, max 24 hours each
- Image cache: ~100 entries, max 30 days each
- Total maximum: ~15 MB (5 MB per cache × 3 caches)

## Troubleshooting

### Service Worker Not Updating

**Problem**: Changes to the app don't appear after deployment.

**Solution**:
1. Hard refresh: Ctrl+Shift+R (Windows/Linux) or Cmd+Shift+R (Mac)
2. Or: DevTools → Application → Service Workers → "Update"
3. Or: Clear site data and reload

### Offline Queue Not Working

**Problem**: Messages sent while offline are not queued.

**Solution**:
1. Check browser console for IndexedDB errors
2. Ensure IndexedDB is not disabled (private browsing may block it)
3. Check storage quota: DevTools → Application → Storage
4. Verify `offlineQueueService` is initialized in `message.service.ts`

### PWA Install Prompt Not Appearing

**Problem**: Install banner doesn't show up.

**Solution**:
1. Ensure app is served over HTTPS (or localhost)
2. Check manifest is valid: DevTools → Application → Manifest
3. Check service worker is registered: DevTools → Application → Service Workers
4. Clear site data and reload
5. Note: Firefox doesn't show install prompts (by design)

### Offline Page Not Showing

**Problem**: Users see browser's default offline page.

**Solution**:
1. Ensure `offline.html` is in `public/` folder
2. Check it's included in service worker: look for it in precache manifest
3. Rebuild the app: `npm run build`
4. Clear cache and reload

## Future Enhancements

### Recommended Improvements

1. **Background Sync API**
   - Use Background Sync API for more reliable offline message sending
   - Automatically retry failed requests in background

2. **Push Notifications Integration**
   - Integrate offline queue with push notification system
   - Notify users when queued messages are sent

3. **Cache Analytics**
   - Track cache hit/miss rates
   - Monitor storage usage
   - Alert when approaching storage limits

4. **Selective Sync**
   - Allow users to choose which conversations to cache for offline
   - Pre-cache important conversations

5. **PWA Icons**
   - Generate proper PWA icons in multiple sizes (192x192, 512x512)
   - Add maskable icons for Android adaptive icons

6. **Update Strategy**
   - Implement version checking
   - Show changelog on update
   - Allow users to defer non-critical updates

## References

- [Vite PWA Plugin](https://vite-pwa-org.netlify.app/)
- [Workbox](https://developers.google.com/web/tools/workbox)
- [PWA Best Practices](https://web.dev/pwa/)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [IndexedDB API](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API)

## Support

For issues or questions about the PWA implementation:

1. Check the browser console for errors
2. Review this documentation
3. Check the vite-plugin-pwa documentation
4. Open an issue on the project repository
